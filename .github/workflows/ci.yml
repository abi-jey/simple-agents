name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      publish_dev:
        description: 'Publish dev release to PyPI'
        required: false
        default: false
        type: boolean
      version_bump:
        description: 'Version bump type (automatically publishes stable release)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - patch
          - minor
          - major

jobs:
  # =============================================================================
  # BUMP VERSION (runs first if requested, then triggers full rebuild)
  # =============================================================================
  bump-version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.version_bump != 'none'
    outputs:
      version: ${{ steps.bump.outputs.version }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install toml

      - name: Bump version
        id: bump
        run: |
          import toml
          import os

          bump_type = "${{ inputs.version_bump }}"

          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)

          current = config['project']['version']
          parts = current.split('.')
          major, minor, patch = int(parts[0]), int(parts[1]), int(parts[2].split('-')[0].split('.dev')[0])

          if bump_type == 'major':
              major += 1
              minor = 0
              patch = 0
          elif bump_type == 'minor':
              minor += 1
              patch = 0
          elif bump_type == 'patch':
              patch += 1

          new_version = f"{major}.{minor}.{patch}"

          config['project']['version'] = new_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(config, f)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={new_version}\n")

          print(f"Bumped version: {current} -> {new_version}")
        shell: python

      - name: Commit and push version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add pyproject.toml
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push

  # =============================================================================
  # LINT
  # =============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: [bump-version]
    if: always() && (needs.bump-version.result == 'success' || needs.bump-version.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      # Pull latest if version was bumped
      - name: Pull latest changes
        if: needs.bump-version.result == 'success'
        run: git pull origin ${{ github.ref_name }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files

  # =============================================================================
  # LINUX TESTS
  # =============================================================================
  test-linux:
    name: Test Linux (py${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [lint]
    if: always() && needs.lint.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install package and test dependencies
        run: pip install -e ".[dev]"

      - name: Verify package import
        run: python -c "from nagents import Agent, Provider, ProviderType; print('Package imports work')"

      - name: Run tests
        run: pytest tests/ -v --cov=nagents --cov-report=xml --cov-report=term-missing

      - name: Upload coverage
        if: matrix.python-version == '3.12'
        uses: codecov/codecov-action@v5
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # =============================================================================
  # MACOS TESTS
  # =============================================================================
  test-macos:
    name: Test macOS (py${{ matrix.python-version }})
    runs-on: macos-latest
    needs: [lint]
    if: always() && needs.lint.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install package and test dependencies
        run: pip install -e ".[dev]"

      - name: Verify package import
        run: python -c "from nagents import Agent, Provider, ProviderType; print('Package imports work')"

      - name: Run tests
        run: pytest tests/ -v

  # =============================================================================
  # WINDOWS TESTS
  # =============================================================================
  test-windows:
    name: Test Windows (py${{ matrix.python-version }})
    runs-on: windows-latest
    needs: [lint]
    if: always() && needs.lint.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.11', '3.12', '3.13', '3.14']
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        shell: bash
        run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          allow-prereleases: true

      - name: Install package and test dependencies
        run: pip install -e ".[dev]"

      - name: Verify package import
        run: python -c "from nagents import Agent, Provider, ProviderType; print('Package imports work')"

      - name: Run tests
        run: pytest tests/ -v

  # =============================================================================
  # BUILD DISTRIBUTION
  # =============================================================================
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: [test-linux, test-macos, test-windows]
    if: |
      always() &&
      needs.test-linux.result == 'success' &&
      needs.test-macos.result == 'success' &&
      needs.test-windows.result == 'success'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build hatch

      - name: Build wheel and sdist
        run: python -m build

      - name: List artifacts
        run: ls -la dist/

      - uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # =============================================================================
  # PUBLISH & RELEASE (Stable)
  # =============================================================================
  publish-stable:
    name: Publish & Release (Stable)
    runs-on: ubuntu-latest
    needs: [bump-version, build]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && inputs.version_bump != 'none'))
    environment:
      name: pypi-stable
      url: https://pypi.org/project/nagents/
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }} || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install toml

      - name: Get version
        id: version
        run: |
          import toml
          import os

          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)

          version = config['project']['version']

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={version}\n")

          print(f"Version: {version}")
        shell: python

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

      - name: Get previous stable tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag -l 'v*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -2 | tail -1)
          if [ -z "$PREV_TAG" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous stable tag: $PREV_TAG"

      - name: Generate release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG="${{ steps.prev_tag.outputs.prev_tag }}"

          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md

          git log ${PREV_TAG}..HEAD --pretty=format:"* %s (%h)" --no-merges >> release_notes.md

          echo "" >> release_notes.md
          echo "" >> release_notes.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...v${VERSION}" >> release_notes.md

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: dist/*

  # =============================================================================
  # PUBLISH & RELEASE (Dev)
  # =============================================================================
  publish-dev:
    name: Publish & Release (Dev)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'workflow_dispatch' && inputs.publish_dev
    environment:
      name: pypi-dev
      url: https://pypi.org/project/nagents/
    permissions:
      id-token: write
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install toml build

      - name: Generate dev version
        id: version
        run: |
          import toml
          import os
          from datetime import datetime

          with open('pyproject.toml', 'r') as f:
              config = toml.load(f)

          base_version = config['project']['version']
          timestamp = datetime.now().strftime('%Y%m%d%H%M%S')

          dev_version = f"{base_version}.dev{timestamp}"

          config['project']['version'] = dev_version
          with open('pyproject.toml', 'w') as f:
              toml.dump(config, f)

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"version={dev_version}\n")

          print(f"Dev version: {dev_version}")
        shell: python

      - name: Build wheel and sdist
        run: python -m build

      - name: List artifacts
        run: ls -la dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Dev v${{ steps.version.outputs.version }}
          prerelease: true
          generate_release_notes: true
          files: dist/*
